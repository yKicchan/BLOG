---
title: 'docker-compose.yml ã‚’ç’°å¢ƒã”ã¨ã«åˆ†å‰²ã™ã‚‹'
excerpt: 'prod ã¨ stg ã¨ dev ã¨ã‹ã§å¤§éƒ¨åˆ†ã¯åŒã˜ã ã‘ã© ï¾ï½®ï½¯ï¾„ï¾ï½¶ï¾ï½³ ã¨ã“ã‚ã ã‘åˆ†å‰²ã—ãŸã„ã¨ãã¨ã‹ã«æœ‰ç”¨ãªæŠ€'
createdAt: '2020-07-13'
tags:
  - 'Docker Compose'
  - 'Docker'
---

## å‰æ

Compose ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒãƒ¼ã‚·ãƒ§ãƒ³ 3.x

## çµè«–

`-f` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†

```bash
$ docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

ã¾ãŸã¯ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ã†: `COMPOSE_FILE`, `COMPOSE_PATH_SEPARATOR`

```bash
$ export COMPOSE_PATH_SEPARATOR=:
$ export COMPOSE_FILE=docker-compose.yml:docker-compose.prod.yml
$ docker-compose up -d
```

[ãƒ•ã‚¡ã‚¤ãƒ«é–“ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–“ã§ã® Compose è¨­å®šã®å…±æœ‰ â€” Docker-docs-ja 17.06 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](http://docs.docker.jp/compose/extends.html)

## æ³¨æ„

- `extends` ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 2.1 ã¾ã§ã®ã‚µãƒãƒ¼ãƒˆã§ã€(2020å¹´7æœˆç¾åœ¨)ã§ã¯ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“ğŸ™…â€â™€ï¸
- `COMPOSE_FILE`ã®åŒºåˆ‡ã‚Šæ–‡å­—ã¯OSã«ã‚ˆã£ã¦ç•°ãªã‚‹ã®ã§`COMPOSE_PATH_SEPARATOR`ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã—ã¦ãŠãã¨ç„¡é›£
- `-f`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã¯ãªãç’°å¢ƒå¤‰æ•°ã‚’ä½¿ã†å ´åˆã¯ä»–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å½±éŸ¿ã™ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ãã“ã¯æ³¨æ„

## Makefile ã¨åˆã‚ã›ã¦ä½¿ã†

ç°¡å˜ãªä¾‹ã¨ã—ã¦ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã€ç’°å¢ƒç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã‚Œãã‚Œç”¨æ„ã—ãŸã€‚

```yml
# docker-compose.yml
version: "3"
volumes:
  app-node_modules:
  app-dist:
services:
  app:
    build: ./app
    container_name: app
    volumes:
      - ./app/src:/usr/app
      - app-node_modules:/usr/app/node_modules
      - app-dist:/usr/app/dist
```

```yml
# docker-compose.prod.yml
version: "3"
services:
  app:
    ports:
      - 80:80
    environment:
      PRODUCTION: 'true'
```

```yml
# docker-compose.local.yml
version: "3"
services:
  app:
    ports:
      - 8080:80
    environment:
      DEBUG: 'true'
```

ã“ã‚Œã‚‰ã‚’ç’°å¢ƒã«ã‚ˆã£ã¦åˆ‡ã‚Šæ›¿ãˆã‚‹ãŸã‚ã® Makefile ã‚’ä½œã‚‹  
ã“ã“ã§ã¯ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ã£ã¦ docker-compose ã®ä¸Šæ›¸ãã‚’æƒ³å®šã—ãŸ

```makefile
# æœ¬ç•ªã§ã¯ make [cmd] e=prod ã¨ã™ã‚‹

# local or prod
ENV=local

pre:
ifdef e
ENV=${e}
endif

set-env := export ENV=$(ENV) ;\
           export COMPOSE_PATH_SEPARATOR=: ;\
           export COMPOSE_FILE=docker-compose.yml:docker-compose.$(ENV).yml

up: pre
    $(set-env)\
    docker-compose up -d

down: pre
    $(set-env)\
    docker-compose down

rebuild: pre
    $(set-env)\
    docker-compose build --no-cache
```

ä¸Šè¨˜ã®è¨­å®šã§ç’°å¢ƒã”ã¨ã«ã‚³ãƒãƒ³ãƒ‰ã§åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸğŸ‘

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º
$ make rebuild
$ make up
$ make down

# æœ¬ç•ªç’°å¢ƒ
$ make rebuild e=prod
$ make up e=prod
$ make down e=prod
```

ã“ã‚Œã¯ç°¡å˜ãªä¾‹ã ãŒã€å®Ÿéš›ã«ã¯ã‚ˆã‚Šå¤šãã®è¨­å®šã«ãªã‚‹ãŸã‚ã€å¤šãã®å†—é•·ãªè¨­å®šã‹ã‚‰è§£æ”¾ã•ã‚Œã¦å¹¸ã›ã«ãªã‚Œã‚‹â¤ï¸  
Makefile ãŒãªã„ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã‚‚é–‹ç™ºä½“é¨“ã‚‚è½ã¡ã‚‹ã®ã§ã€å«ŒãŒã‚‰ãšã«é–‹ç™ºåºç›¤ã‹ã‚‰ç”¨æ„ã—ã‚ˆã†ğŸ¤—

## çµåˆæ™‚ã®æŒ™å‹•ã«ã¤ã„ã¦

1ã¤ã®å€¤ã‚’æŒã¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‹ã€è¤‡æ•°ã®å€¤ã‚’æŒã¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‹ã§æŒ™å‹•ãŒå¤‰ã‚ã£ã¦ãã‚‹  
ä»¥ä¸‹å…¬å¼ã‚ˆã‚Šå¼•ç”¨: [è¨­å®šã®è¿½åŠ ã¨ä¸Šæ›¸ã â€” Docker-docs-ja 17.06 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](http://docs.docker.jp/compose/extends.html#adding-and-overriding-configuration)

> 1 ã¤ã®å€¤ã—ã‹æŒãŸãªã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ãŸã¨ãˆã° imageã€commandã€mem_limit ã®ã‚ˆã†ãªã‚‚ã®ã¯ã€å¤ã„å€¤ãŒæ–°ã—ã„å€¤ã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚

```yml
# docker-compose.yml
command: python app.py

# docker-compose.prod.yml
command: python otherapp.py

# docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
command: python otherapp.py

# å¾Œã«æ›¸ã„ãŸæ–¹ãŒé©å¿œã•ã‚Œã‚‹
```

> è¤‡æ•°ã®å€¤ã‚’æŒã¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ã¤ã¾ã‚Š portsã€ exposeã€ external_linksã€ dnsã€ dns_searchã€ tmpfs ã§ã¯ã€ä¸¡è€…ã®è¨­å®šã‚’ã¤ãªãåˆã‚ã›ã¾ã™ã€‚

```yml
# docker-compose.yml
expose:
  - "3000"

# docker-compose.prod.yml
expose:
  - "4000"
  - "5000"

# docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
expose:
  - "3000"
  - "4000"
  - "5000"

# ä¸¡è€…é©å¿œã•ã‚Œã‚‹
```

> environmentã€ labelsã€ volumesã€ devices ã®å ´åˆã€Compose ã¯è¨­å®šå†…å®¹ã‚’ "ãƒãƒ¼ã‚¸" ã—ã¦ã€ãƒ­ãƒ¼ã‚«ãƒ«å®šç¾©ã®å€¤ãŒå„ªå…ˆã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```yml
# docker-compose.yml
environment:
  - FOO=original
  - BAR=original

# docker-compose.prod.yml
environment:
  - BAR=local
  - BAZ=local

# docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
environment:
  - FOO=original
  - BAR=local
  - BAZ=local

# ç«¶åˆã—ã¦ãŸã‚‰å¾Œã«æ›¸ã„ãŸæ–¹ãŒå„ªå…ˆã•ã‚Œã€ç«¶åˆã—ã¦ãªã„ã‚‚ã®ã¯é©å¿œã•ã‚Œã‚‹
```

ğŸ’¸ Compose ãƒ•ã‚¡ã‚¤ãƒ«ã®ã”åˆ©ç”¨ã¯è¨ˆç”»çš„ã«ğŸ’¸
